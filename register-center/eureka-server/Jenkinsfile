node('haimaxy-jnlp'){
    stage("Check Out"){
        echo "1.Check Out Sources"
        git  credentialsId: 'github', url: 'https://hub.fastgit.org/bghlove/open-capacity-platform.git'
    }

    stage('Build') {
        echo "2.Build Docker Image Stage"
        sh "cd /home/jenkins/agent/workspace/eureka/register-center/eureka-server"
        sh "mvn -f /home/jenkins/agent/workspace/eureka/register-center/eureka-server/pom.xml clean install -Dmaven.test.skip=true -U"
        sh "docker build -t binguanghui/eureka-server ."
    }
    stage('Push') {
        echo "3.Push Docker Image Stage"
        withCredentials([usernamePassword(credentialsId: 'dockerHub', passwordVariable: 'dockerHubPassword', usernameVariable: 'dockerHubUser')]) {
            sh "docker login -u ${dockerHubUser} -p ${dockerHubPassword}"
            sh "docker push binguanghui/eureka-server"
        }
    }
    stage('Deploy') {
        echo "3. Deploy Stage"
        sh "kubectl apply -f eureka.yaml --record"
    }
}
